name: Run Integration Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
          image: mysql:8.0
          env:
            MYSQL_ROOT_PASSWORD: root_password
            MYSQL_DATABASE: test_db
            MYSQL_USER: test_user
            MYSQL_PASSWORD: test_password
          ports:
            - 3306:3306
          options: >-
            --health-cmd="mysqladmin ping"
            --health-interval=10s
            --health-timeout=5s
            --health-retries=3

      redis:
          image: redis:7-alpine
          ports:
            - 6379:6379
          options: >-
            --health-cmd="redis-cli ping"
            --health-interval=10s
            --health-timeout=5s
            --health-retries=3


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Wait for MySQL
        run: |
          for i in {1..15}; do
            if mysqladmin ping -h"127.0.0.1" -P"3306" -u"test_user" -p"test_password" --silent; then
              echo "MySQL is up"
              break
            fi
            echo "Waiting for MySQL..."
            sleep 2
          done

      - name: Wait for Redis
        run: |
          for i in {1..15}; do
            if redis-cli -h 127.0.0.1 -p 6379 ping | grep -q PONG; then
              echo "Redis is up"
              break
            fi
            echo "Waiting for Redis..."
            sleep 2
          done

      - name: Run migrations
        run: npx knex migrate:latest --env test

      - name: Run seeds
        run: npx knex seed:run --env test

      - name: Run integration tests
        run: npm test -- --runInBand


